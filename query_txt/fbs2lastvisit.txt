set @countX = 1; set @countHn = 0; SELECT * from((SELECT temp_table.hn,temp_table.fname,temp_table.lname,temp_table.vstdttm as lastvisitDate,c_vn.vstdttm as firstvisitDate,temp_table.dd visitInyear,lfbs.fbs from(SELECT o.vn,p.hn,p.fname,p.lname,o.vstdttm,if(p.hn = @countHn,@countX:=@countX+1,@countX:=1) as dd,@countHn:= o.hn as check_hn  from chronic ch JOIN pt p on p.hn=ch.pid LEFT JOIN ovst o on p.hn=o.hn where date(o.vstdttm) BETWEEN 'StartDate' AND 'EndDate' and ch.flag_confirm ='1' and left(ch.chronic,1)='E' ORDER BY p.hn,dd desc ) temp_table  JOIN(SELECT o.hn,o.vstdttm , count(*)-1 as cc from ovst o where date(o.vstdttm) BETWEEN 'StartDate' AND 'EndDate' GROUP BY o.hn ) c_vn  ON c_vn.hn = temp_table.hn and c_vn.cc = temp_table.dd JOIN lbbk l on l.vn=temp_table.vn JOIN lfbs on lfbs.ln=l.ln and lfbs.fbs<>'') UNION ALL (SELECT temp_table.hn,temp_table.fname,temp_table.lname,temp_table.vstdttm as lastvisitDate,c_vn.vstdttm as firstvisitDate,temp_table.dd visitInyear,lfbs.fbs from(SELECT o.vn,p.hn,p.fname,p.lname,o.vstdttm,if(p.hn = @countHn,@countX:=@countX+1,@countX:=1) as dd,@countHn:= o.hn as check_hn  from chronic ch JOIN pt p on p.hn=ch.pid LEFT JOIN ovst o on p.hn=o.hn where date(o.vstdttm) BETWEEN 'StartDate' AND 'EndDate' and ch.flag_confirm ='1' and left(ch.chronic,1)='E' ORDER BY p.hn,dd desc ) temp_table  JOIN(SELECT o.hn,o.vstdttm , count(*) as cc from ovst o where date(o.vstdttm) BETWEEN 'StartDate' AND 'EndDate' GROUP BY o.hn ) c_vn  ON c_vn.hn = temp_table.hn and c_vn.cc = temp_table.dd JOIN lbbk l on l.vn=temp_table.vn JOIN lfbs on lfbs.ln=l.ln and lfbs.fbs<>'' )) dataDM ORDER BY hn